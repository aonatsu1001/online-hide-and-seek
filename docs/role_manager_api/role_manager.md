# ゲーム役割管理API仕様書

## 概要
このドキュメントは、オンラインかくれんぼゲームにおけるプレイヤーの役割選択とリアルタイム通信に関するAPIエンドポイントの詳細を記述します。

## ベースURL
`http://localhost:8000/game`

## エンドポイント

### 1. 役割選択
- **パス:** `/select-role`
- **HTTPメソッド:** `POST`
- **目的:** プレイヤーが「鬼（SEEKER）」か「隠れる側（HIDER）」かを選択します。
- **リクエストボディ:**
    ```json
    {
      "username": "string", // 役割を選択するプレイヤーのID（ユーザー名など）
      "role": "string",      // 選択する役割 ("HIDER" または "SEEKER")
      "room_id": "string"    // プレイヤーが属するルームのID
    }
    ```
- **レスポンス:**
    - **ステータスコード:** `200 OK`
    - **ボディ:**
        ```json
        {
          "message": "string" // 役割選択成功メッセージ
        }
        ```
    - **ステータスコード:** `422 Unprocessable Entity` (バリデーションエラー)
    - **ボディ:**
        ```json
        {
          "detail": "無効なデータです" // またはFastAPIのデフォルトバリデーションエラー
        }
        ```
    - **説明:** 指定された`username`、`role`、`room_id`をサーバーに送信し、サーバーは該当ルームのプレイヤーの役割を記録します。役割が選択されると、WebSocketを通じて同じルームの他の接続中のクライアントに役割情報がブロードキャストされます。

### 2. WebSocket接続
- **パス:** `/ws/{room_id}`
- **プロトコル:** `WebSocket`
- **目的:** リアルタイム通信のためのWebSocket接続を確立します。
- **パスパラメータ:**
    - `room_id` (string, 必須): 接続するルームの一意のID。
- **接続確立時:**
    - サーバーは、接続が確立されたルームの現在の全プレイヤーの役割情報をJSON形式で送信します。
    - 例: `{"type": "role_update", "players": {"player1": "HIDER", "player2": "SEEKER"}}`
- **メッセージ受信時:**
    - クライアントからJSON形式のメッセージを受信した場合、サーバーはそれを解析し、`event`フィールドに基づいて処理します。
    - **`set_hiding_spot` イベント**: 隠れる側のプレイヤーが隠れ場所を決定した際に送信されます。
        - メッセージ例: `{"event": "set_hiding_spot", "data": {"id": "bookshelf-left"}}`
        - サーバーはこのメッセージを受け取ると、隠れ場所IDを保存し、`hiding_spot_chosen` イベントを探す側にブロードキャストします。
    - その他のメッセージ（例: チャットメッセージ）を受信した場合、サーバーはそれを解析し、同じルーム内の他のクライアントにブロードキャストします。
        - 例: クライアントから`{"type": "message", "content": "Hello"}`のようなJSONメッセージを受信した場合、サーバーは`{"type": "message", "content": "Hello", "room_id": "..."}`のようなJSON文字列をブロードキャストします。
- **メッセージ送信時 (サーバーからクライアントへ):**
    - プレイヤーが役割を選択するたびに、サーバーは接続中の同じルームのすべてのクライアントに最新のプレイヤー役割情報をブロードキャストします。
    - **`hiding_spot_chosen` イベント**: 隠れ場所が決定された後、サーバーから探す側のプレイヤーに送信されます。
        - メッセージ例: `{"event": "hiding_spot_chosen", "data": {"id": "bookshelf-left"}}`
        - フロントエンドの `GamePage_seek_hidding` はこのメッセージを待ち受け、受信次第 `GamePage_seek_seeking` へ遷移するトリガーとなります。
    - クライアントから受信した一般的なメッセージも、同じルーム内の他のクライアントにブロードキャストされます。
- **切断時:**
    - クライアントが切断された場合、サーバーは接続リストからそのクライアントを削除します。ルームに誰もいなくなった場合、そのルームの接続管理情報も削除されます。
- **説明:** クライアントがこのエンドポイントに接続すると、サーバーとの間に永続的な通信チャネルが確立されます。役割選択やチャットなどのイベントが発生すると、サーバーはこのWebSocketを通じて同じルームのクライアントにリアルタイムで情報を送信します。これは、ゲームの状態をリアルタイムで同期するために使用されます。

## エラーハンドリング
- APIリクエストが失敗した場合、HTTPステータスコードとJSON形式のエラーメッセージが返されます。
- WebSocket接続の場合、接続が切断されるか、エラーが発生した場合にサーバー側でログが出力されます。
